// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © henry_oliver
// Moving Averages with Trend Indicator

//@version=6
indicator(title = "MAs & Waves", shorttitle = "MA&W", overlay = true, calc_on_every_tick = calcOnEveryTick)

// === CONSTANTS ===
// Nord Theme Color
const color NORD0  = #2E3440
const color NORD1  = #3B4252
const color NORD2  = #434C5E
const color NORD3  = #4C566A
const color NORD4  = #D8DEE9
const color NORD5  = #E5E9F0
const color NORD6  = #ECEFF4
const color NORD7  = #8FBCBB
const color NORD8  = #88C0D0
const color NORD9  = #81A1C1
const color NORD10 = #5E81AC
const color NORD11 = #BF616A
const color NORD12 = #D08770
const color NORD13 = #EBCB8B
const color NORD14 = #A3BE8C
const color NORD15 = #B48EAD

// Calculation Constants
const string TREND_UP     = "up"
const string TREND_DOWN   = "down"
const string TREND_FLAT   = "flat"

const float RADIANS_TO_DEGREES = 180 / math.pi

// === INPUTS ===
// General
calcOnEveryTick = input.bool(defval = false, title = "Calculate On Every Tick", group = "General", tooltip = "When checked, the script calculates on every incoming tick. When unchecked (default), it calculates only on bar close. Enabling this may lead to repainting and higher resource usage.")
src = input.source(defval = close, title = "Source", group = "General")

// EMA
emaVisible = input.bool(defval = true, title = "Visible", group = "EMA")
emaLength = input.int(defval = 15, title = "Length", minval = 1, group = "EMA")
emaOffset = input.int(defval = 0, title = "Offset", minval = -500, maxval = 500, group = "EMA")
emaColor = input.color(defval = NORD3, title = "Color", group = "EMA")
emaWidth = input.int(defval = 2, title = "Line Width", minval = 1, maxval = 10, group = "EMA")

// SMA 1 (50 SMA - THE TREND INDICATOR)
sma1Visible = input.bool(defval = true, title = "Visible", group = "SMA 1")
sma1Length = input.int(defval = 50, title = "Length", minval = 1, group = "SMA 1")
sma1Offset = input.int(defval = 0, title = "Offset", minval = -500, maxval = 500, group = "SMA 1")
sma1TrendLookback = input.int(defval = 5, title = "Trend Lookback (Bars)", minval = 1, maxval = 20,
     tooltip = "Number of bars to look back to determine slope angle", group = "SMA 1")
sma1FlatThreshold = input.float(defval = 0.0001, title = "Flat Threshold (Degrees)", minval = 0.0001, maxval = 5.0, step = 0.0001,
     tooltip = "Angle threshold in degrees - slopes between -threshold and +threshold are considered flat", group = "SMA 1")
sma1ColorUp = input.color(defval = color.new(color = NORD8, transp = 60), title = "Color (Up)", group = "SMA 1")
sma1ColorNeutral = input.color(defval = NORD2, title = "Color (Neutral)", group = "SMA 1")
sma1ColorDown = input.color(defval = color.new(color = NORD11, transp = 60), title = "Color (Down)", group = "SMA 1")
sma1Width = input.int(defval = 3, title = "Line Width", minval = 1, maxval = 10, group = "SMA 1")

// SMA 2 & 3
sma2Visible = input.bool(defval = true, title = "Visible", group = "SMA 2")
sma2Length = input.int(defval = 100, title = "Length", minval = 1, group = "SMA 2")
sma2Offset = input.int(defval = 0, title = "Offset", minval = -500, maxval = 500, group = "SMA 2")
sma2Color = input.color(defval = NORD1, title = "Color", group = "SMA 2")
sma2Width = input.int(defval = 4, title = "Line Width", minval = 1, maxval = 10, group = "SMA 2")

sma3Visible = input.bool(defval = true, title = "Visible", group = "SMA 3")
sma3Length = input.int(defval = 200, title = "Length", minval = 1, group = "SMA 3")
sma3Offset = input.int(defval = 0, title = "Offset", minval = -500, maxval = 500, group = "SMA 3")
sma3Color = input.color(defval = NORD1, title = "Color", group = "SMA 3")
sma3Width = input.int(defval = 5, title = "Line Width", minval = 1, maxval = 10, group = "SMA 3")

// === CALCULATIONS ===
ema = ta.ema(source = src, length = emaLength)
sma1 = ta.sma(source = src, length = sma1Length)
sma2 = ta.sma(source = src, length = sma2Length)
sma3 = ta.sma(source = src, length = sma3Length)

// SMA 1 Slope (THE TREND INDICATOR)
sma1Height = ta.change(sma1, sma1TrendLookback)
sma1SlopeAngle = na(sma1Height) or sma1Height == 0 ? 0 : math.atan(sma1Height / sma1TrendLookback) * RADIANS_TO_DEGREES

sma1Trend = math.abs(sma1SlopeAngle) < sma1FlatThreshold ? TREND_FLAT : sma1SlopeAngle > 0 ? TREND_UP : TREND_DOWN
sma1CurrentColor = switch sma1Trend
    TREND_UP => sma1ColorUp
    TREND_DOWN => sma1ColorDown
    => sma1ColorNeutral

// === PLOTS ===
plot(series = emaVisible ? ema : na, title = "EMA", color = emaColor, linewidth = emaWidth, offset = emaOffset)
plot(series = sma1Visible ? sma1 : na, title = "SMA 1", color = sma1CurrentColor, linewidth = sma1Width, offset = sma1Offset)
plot(series = sma2Visible ? sma2 : na, title = "SMA 2", color = sma2Color, linewidth = sma2Width, offset = sma2Offset)
plot(series = sma3Visible ? sma3 : na, title = "SMA 3", color = sma3Color, linewidth = sma3Width, offset = sma3Offset)

