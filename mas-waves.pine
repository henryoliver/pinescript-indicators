// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © henry_oliver
// Moving Average with Trend Indicator

//@version=6
indicator(title = "MAs & Waves", shorttitle = "MA&W", overlay = true, timeframe = "", timeframe_gaps = true)

// === CONSTANTS ===
// Nord Theme Colors
const color NORD0  = #2E3440
const color NORD1  = #3B4252
const color NORD2  = #434C5E
const color NORD3  = #4C566A
const color NORD4  = #D8DEE9
const color NORD5  = #E5E9F0
const color NORD6  = #ECEFF4
const color NORD7  = #8FBCBB
const color NORD8  = #88C0D0
const color NORD9  = #81A1C1
const color NORD10 = #5E81AC
const color NORD11 = #BF616A
const color NORD12 = #D08770
const color NORD13 = #EBCB8B
const color NORD14 = #A3BE8C
const color NORD15 = #B48EAD

// Trend States
const string TREND_UP   = "up"
const string TREND_DOWN = "down"
const string TREND_FLAT = "flat"

// === INPUTS ===
// General Settings
src = input(defval = close, title = "Source")
smaLength = input.int(defval = 50, title = "Length", minval = 1)
smaOffset = input.int(defval = 0, title = "Offset", minval = -500, maxval = 500, display = display.none)
smaWidth = input.int(defval = 3, title = "Line Width", minval = 1, maxval = 10)

// Trend Detection Settings
trendLookback = input.int(defval = 1, title = "Lookback Period (Bars)", minval = 1, maxval = 20,
     tooltip = "Number of bars to look back when calculating the slope", group = "Trend Detection", display = display.none)
flatThreshold = input.float(defval = 0.0001, title = "Flat Threshold", minval = 0.0001, maxval = 10.0, step = 0.0001,
     tooltip = "Slope values between -threshold and +threshold are considered flat/neutral", group = "Trend Detection", display = display.none)

// Color Settings
colorUp = input.color(defval = color.new(color = NORD8, transp = 20), title = "Uptrend Color", group = "Trend Colors")
colorFlat = input.color(defval = NORD2, title = "Flat/Neutral Color", group = "Trend Colors")
colorDown = input.color(defval = color.new(color = NORD9, transp = 60), title = "Downtrend Color", group = "Trend Colors")

// === CALCULATIONS ===
// Calculate the Simple Moving Average
sma = ta.sma(source = src, length = smaLength)

// Calculate Slope (Direct comparison - no trigonometric functions for better performance)
// Slope = change in SMA value over the lookback period
smaSlope = ta.change(source = sma, length = trendLookback)

// Determine Trend Direction
// If absolute slope is less than threshold: FLAT
// If slope is positive: UPTREND
// If slope is negative: DOWNTREND
trend = math.abs(smaSlope) < flatThreshold ? TREND_FLAT : smaSlope > 0 ? TREND_UP : TREND_DOWN

// Select Color Based on Trend
smaColor = switch trend
    TREND_UP => colorUp
    TREND_DOWN => colorDown
    => colorFlat

// === PLOT ===
plot(series = sma, title = "SMA", color = smaColor, linewidth = smaWidth, offset = smaOffset)

